<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comprehensive interactive map showing geographic patterns of US governance, politics, economics, and demographics from 1776-2025">
    <meta name="keywords" content="US history, interactive map, governance, politics, economics, demographics, geographic analysis, American history">
    <meta name="author" content="Marion Fox">
    <meta property="og:title" content="US Governance: Geographic & Historical Analysis">
    <meta property="og:description" content="Interactive map exploring 250 years of American governance patterns across geography, politics, and economics">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://jessicatemplet.com/Political-map-/preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="US Governance: Geographic & Historical Analysis">
    <meta name="twitter:description" content="Interactive map of American governance patterns from 1776-2025">
    <title>US Governance: Geographic & Historical Analysis</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: bold;
            color: #333;
        }
        
        .time-control {
            flex: 2;
            min-width: 300px;
        }
        
        .layer-control {
            flex: 1;
            min-width: 200px;
        }
        
        .play-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .time-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .year-display {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin: 10px 0;
        }
        
        .map-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .info-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 200px;
        }
        
        .legend {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 12px;
            min-width: 150px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        .state {
            stroke: #333;
            stroke-width: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .state:hover {
            stroke: #000;
            stroke-width: 2px;
        }
        
        .state-label {
            font-family: sans-serif;
            pointer-events: none;
            font-size: 10px;
            text-anchor: middle;
            fill: black;
            font-weight: bold;
            text-shadow: 
                -1px -1px 0 #fff,  
                1px -1px 0 #fff,
                -1px 1px 0 #fff,
                1px 1px 0 #fff;
        }
        
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .period-indicator {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .data-sources {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
        }
        
        #map-svg {
            width: 100%;
            height: 600px;
        }
        
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input[type="range"] {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>US Governance: Geographic & Historical Analysis (1776-2025)</h1>
            <p>Interactive visualization showing the geographic patterns of majority vs. elite governance across American history</p>
        </div>

        <div class="controls">
            <div class="control-group time-control">
                <label>Time Period</label>
                <div class="year-display" id="yearDisplay">1776</div>
                <input type="range" class="time-slider" id="timeSlider" min="1776" max="2025" value="1776" step="1">
                <div class="play-controls">
                    <button id="playBtn">Play</button>
                    <button id="pauseBtn" disabled>Pause</button>
                    <button id="resetBtn">Reset</button>
                    <span>Speed: <select id="speedSelect">
                        <option value="100">Slow</option>
                        <option value="50" selected>Medium</option>
                        <option value="25">Fast</option>
                    </select></span>
                </div>
            </div>

            <div class="control-group layer-control">
                <label>Data Layer</label>
                <select id="layerSelect">
                    <option value="governance">Governance Focus</option>
                    <option value="party">Party Control</option>
                    <option value="economic">Economic Centers</option>
                    <option value="policy">Policy Impact</option>
                    <option value="demographics">Demographics</option>
                    <option value="labor">Labor Organization</option>
                </select>
            </div>

            <div class="control-group">
                <label>Display Options</label>
                <div>
                    <input type="checkbox" id="showLegend" checked> <label for="showLegend">Show Legend</label><br>
                    <input type="checkbox" id="showTooltips" checked> <label for="showTooltips">Show Tooltips</label><br>
                    <input type="checkbox" id="animateTransitions" checked> <label for="animateTransitions">Animate Changes</label>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div class="period-indicator" id="periodIndicator">Early Republic (1776-1830): Elite-Focused Governance</div>
            <svg id="map-svg"></svg>
            <div class="legend" id="legend"></div>
            <div class="tooltip" id="tooltip"></div>
        </div>

        <div class="info-panel" id="infoPanel">
            <h3>Historical Context</h3>
            <p>Select a time period and click on states to explore the complex relationships between geography, politics, and governance throughout American history. Use the time slider to see how patterns evolved over 250 years.</p>
        </div>

        <div class="data-sources">
            <h4>Data Sources & Methodology</h4>
            <p><strong>Sources:</strong> Historical election data, Census records, economic indicators, policy implementation records, labor statistics, and academic historical research.</p>
            <p><strong>Note:</strong> This visualization represents historical trends and patterns. Complex historical periods are necessarily simplified for visualization purposes. Regional variations within states are not fully captured in state-level data.</p>
        </div>
    </div>

    <script>
        // Historical periods data
        const historicalPeriods = [
            { name: "Early Republic", years: [1776, 1830], description: "Elite-Focused Governance: Power concentrated among wealthy landowners and merchants", governance: "elite" },
            { name: "Jacksonian Era", years: [1829, 1837], description: "Majority-Focused: Expanded suffrage to white men, opposition to National Bank", governance: "majority" },
            { name: "Antebellum Period", years: [1838, 1869], description: "Mixed/Sectional: Regional tensions over slavery, economic development", governance: "mixed" },
            { name: "Gilded Age", years: [1870, 1890], description: "Elite-Focused: Railroad barons, industrial magnates dominate politics", governance: "elite" },
            { name: "Progressive Era", years: [1890, 1920], description: "Majority-Focused: Antitrust laws, labor protections, democratic reforms", governance: "majority" },
            { name: "Roaring Twenties", years: [1920, 1932], description: "Elite-Focused: Business-friendly policies, limited regulation", governance: "elite" },
            { name: "New Deal Era", years: [1933, 1945], description: "Majority-Focused: Social programs, labor rights, economic intervention", governance: "majority" },
            { name: "Postwar Consensus", years: [1945, 1970], description: "Majority-Focused: Middle class expansion, high taxes on wealthy", governance: "majority" },
            { name: "Civil Rights Era", years: [1950, 1968], description: "Majority-Focused: Expanding democratic participation, civil rights", governance: "majority" },
            { name: "Conservative Revolution", years: [1980, 2008], description: "Elite-Focused: Deregulation, tax cuts for wealthy, union decline", governance: "elite" },
            { name: "Obama Era", years: [2009, 2016], description: "Mixed: Healthcare expansion, but continued elite influence", governance: "mixed" },
            { name: "Recent Period", years: [2017, 2025], description: "Mixed: Contemporary period with ongoing political polarization", governance: "mixed" }
        ];

        // State name to abbreviation lookup table (required because the map data doesn't have abbreviations)
        const stateAbbreviations = {
            "Alabama": "AL", "Alaska": "AK", "Arizona": "AZ", "Arkansas": "AR", "California": "CA",
            "Colorado": "CO", "Connecticut": "CT", "Delaware": "DE", "District of Columbia": "DC",
            "Florida": "FL", "Georgia": "GA", "Hawaii": "HI", "Idaho": "ID", "Illinois": "IL",
            "Indiana": "IN", "Iowa": "IA", "Kansas": "KS", "Kentucky": "KY", "Louisiana": "LA",
            "Maine": "ME", "Maryland": "MD", "Massachusetts": "MA", "Michigan": "MI", "Minnesota": "MN",
            "Mississippi": "MS", "Missouri": "MO", "Montana": "MT", "Nebraska": "NE", "Nevada": "NV",
            "New Hampshire": "NH", "New Jersey": "NJ", "New Mexico": "NM", "New York": "NY",
            "North Carolina": "NC", "North Dakota": "ND", "Ohio": "OH", "Oklahoma": "OK", "Oregon": "OR",
            "Pennsylvania": "PA", "Rhode Island": "RI", "South Carolina": "SC", "South Dakota": "SD",
            "Tennessee": "TN", "Texas": "TX", "Utah": "UT", "Vermont": "VT", "Virginia": "VA",
            "Washington": "WA", "West Virginia": "WV", "Wisconsin": "WI", "Wyoming": "WY"
        };

        // Sample state data with all 50 states included
        const stateData = {
            "AL": { governance: { 1776: "elite", 1850: "mixed", 1933: "majority", 1980: "elite" }, party: { 1840: "democratic", 1860: "independent", 1980: "republican" } },
            "AK": { governance: { 1959: "mixed", 1980: "elite" }, party: { 1959: "democratic", 1980: "republican" } },
            "AZ": { governance: { 1912: "mixed", 1980: "elite", 2000: "mixed" }, party: { 1912: "democratic", 1950: "republican", 1990: "mixed" } },
            "AR": { governance: { 1836: "elite", 1933: "majority", 1980: "elite" }, party: { 1840: "democratic", 1980: "republican" } },
            "CA": {
                governance: { 1776: "elite", 1850: "mixed", 1900: "majority", 1920: "elite", 1933: "majority", 1980: "mixed", 2000: "majority" },
                party: { 1776: "none", 1850: "democratic", 1900: "republican", 1933: "democratic", 1968: "republican", 1992: "democratic" },
                economic: { 1776: "agricultural", 1850: "gold_rush", 1900: "diversified", 1950: "industrial", 1990: "tech" },
                policy: { 1933: "new_deal_high", 1960: "civil_rights_high", 1980: "conservative_low" },
                demographics: { 1850: "frontier", 1900: "immigrant_heavy", 1950: "suburban", 2000: "diverse_urban" },
                labor: { 1900: "weak", 1940: "strong", 1980: "declining", 2000: "mixed" }
            },
            "CO": { governance: { 1876: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1876: "republican", 1933: "democratic", 1980: "mixed" } },
            "CT": { governance: { 1776: "elite", 1829: "majority", 1870: "elite", 1933: "majority" }, party: { 1776: "federalist", 1829: "democratic", 1870: "republican" } },
            "DE": { governance: { 1776: "elite", 1829: "majority", 1933: "mixed" }, party: { 1776: "federalist", 1829: "democratic", 1950: "republican", 2000: "democratic" } },
            "FL": { governance: { 1845: "elite", 1933: "mixed", 1980: "elite" }, party: { 1845: "democratic", 1980: "republican" } },
            "GA": { governance: { 1776: "elite", 1830: "mixed", 1933: "majority", 1980: "elite" }, party: { 1776: "none", 1830: "democratic", 1980: "republican" } },
            "HI": { governance: { 1959: "mixed", 1980: "majority" }, party: { 1959: "democratic" } },
            "ID": { governance: { 1890: "mixed", 1933: "majority", 1980: "elite" }, party: { 1890: "republican" } },
            "IL": { governance: { 1818: "mixed", 1870: "elite", 1933: "majority" }, party: { 1818: "democratic", 1860: "republican", 1933: "democratic" } },
            "IN": { governance: { 1816: "mixed", 1870: "elite", 1933: "majority" }, party: { 1816: "democratic", 1860: "republican", 1933: "democratic" } },
            "IA": { governance: { 1846: "mixed", 1870: "majority", 1980: "mixed" }, party: { 1846: "democratic", 1860: "republican" } },
            "KS": { governance: { 1861: "mixed", 1933: "majority", 1980: "elite" }, party: { 1861: "republican" } },
            "KY": { governance: { 1792: "elite", 1830: "majority", 1933: "majority", 1980: "mixed" }, party: { 1792: "democratic", 1980: "republican" } },
            "LA": { governance: { 1812: "elite", 1830: "mixed", 1933: "majority", 1980: "elite" }, party: { 1812: "democratic", 1980: "republican" } },
            "ME": { governance: { 1820: "mixed", 1870: "majority", 1980: "majority" }, party: { 1820: "democratic", 1860: "republican" } },
            "MD": { governance: { 1776: "elite", 1829: "majority", 1933: "mixed", 1980: "majority" }, party: { 1776: "federalist", 1829: "democratic", 1980: "democratic" } },
            "MA": { governance: { 1776: "elite", 1829: "majority", 1933: "majority" }, party: { 1776: "federalist", 1829: "democratic", 1980: "democratic" } },
            "MI": { governance: { 1837: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1837: "democratic", 1860: "republican" } },
            "MN": { governance: { 1858: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1858: "republican", 1933: "mixed" } },
            "MS": { governance: { 1817: "elite", 1830: "mixed", 1933: "majority", 1980: "elite" }, party: { 1817: "democratic", 1980: "republican" } },
            "MO": { governance: { 1821: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1821: "democratic" } },
            "MT": { governance: { 1889: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1889: "republican", 1933: "democratic" } },
            "NE": { governance: { 1867: "mixed", 1933: "elite", 1980: "elite" }, party: { 1867: "republican" } },
            "NV": { governance: { 1864: "mixed", 1933: "elite", 1980: "mixed" }, party: { 1864: "republican", 1933: "democratic", 1980: "republican" } },
            "NH": { governance: { 1776: "elite", 1829: "majority", 1933: "mixed", 1980: "elite" }, party: { 1776: "federalist", 1829: "democratic" } },
            "NJ": { governance: { 1776: "elite", 1829: "majority", 1933: "mixed" }, party: { 1776: "federalist", 1829: "democratic", 1980: "mixed" } },
            "NM": { governance: { 1912: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1912: "democratic", 1980: "mixed" } },
            "NY": {
                governance: { 1776: "elite", 1829: "majority", 1870: "elite", 1900: "majority", 1933: "majority", 1980: "mixed" },
                party: { 1776: "federalist", 1829: "democratic", 1860: "republican", 1933: "democratic" },
                economic: { 1776: "commercial", 1850: "industrial", 1900: "financial", 2000: "services" },
                policy: { 1933: "new_deal_high", 1960: "civil_rights_high" },
                demographics: { 1850: "immigrant_heavy", 1950: "urban", 2000: "diverse_urban" },
                labor: { 1900: "strong", 1950: "very_strong", 1980: "declining", 2000: "mixed" }
            },
            "NC": { governance: { 1776: "elite", 1829: "mixed", 1933: "majority", 1980: "elite" }, party: { 1776: "none", 1829: "democratic", 1980: "republican" } },
            "ND": { governance: { 1889: "mixed", 1933: "elite", 1980: "mixed" }, party: { 1889: "republican", 1933: "democratic" } },
            "OH": { governance: { 1803: "elite", 1830: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1803: "democratic", 1860: "republican" } },
            "OK": { governance: { 1907: "mixed", 1933: "majority", 1980: "elite" }, party: { 1907: "democratic", 1980: "republican" } },
            "OR": { governance: { 1859: "mixed", 1933: "majority", 1980: "mixed", 2000: "majority" }, party: { 1859: "democratic", 1870: "republican", 1960: "democratic" } },
            "PA": { governance: { 1776: "elite", 1829: "majority", 1870: "elite", 1933: "majority" }, party: { 1776: "federalist", 1829: "democratic", 1860: "republican", 1933: "democratic" } },
            "RI": { governance: { 1776: "elite", 1829: "majority", 1933: "majority" }, party: { 1776: "federalist", 1829: "democratic", 1920: "republican", 1933: "democratic" } },
            "SC": { governance: { 1776: "elite", 1829: "elite", 1933: "majority", 1980: "elite" }, party: { 1776: "none", 1829: "democratic", 1980: "republican" } },
            "SD": { governance: { 1889: "mixed", 1933: "elite", 1980: "elite" }, party: { 1889: "republican" } },
            "TN": { governance: { 1796: "elite", 1830: "majority", 1933: "majority", 1980: "mixed" }, party: { 1796: "democratic", 1980: "republican" } },
            "TX": { governance: { 1845: "elite", 1870: "mixed", 1933: "majority", 1980: "elite" }, party: { 1845: "democratic", 1980: "republican" } },
            "UT": { governance: { 1896: "elite", 1933: "elite", 1980: "elite" }, party: { 1896: "republican" } },
            "VT": { governance: { 1791: "elite", 1829: "majority", 1933: "mixed", 1980: "mixed" }, party: { 1791: "federalist", 1829: "whig", 1860: "republican", 1990: "democratic" } },
            "VA": { governance: { 1776: "elite", 1829: "majority", 1933: "mixed", 1980: "mixed" }, party: { 1776: "none", 1829: "democratic", 1980: "mixed" } },
            "WA": { governance: { 1889: "mixed", 1933: "majority", 1980: "mixed", 2000: "majority" }, party: { 1889: "republican", 1933: "democratic" } },
            "WV": { governance: { 1863: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1863: "republican", 1933: "democratic" } },
            "WI": { governance: { 1848: "mixed", 1933: "majority", 1980: "mixed" }, party: { 1848: "democratic", 1860: "republican" } },
            "WY": { governance: { 1890: "mixed", 1933: "elite", 1980: "elite" }, party: { 1890: "republican" } }
        };

        const colors = {
            governance: {
                elite: "#FF4444",
                majority: "#44AA44", 
                mixed: "#FFAA44"
            },
            party: {
                federalist: "#8B4513",
                democratic: "#4444FF",
                republican: "#FF4444", 
                whig: "#9932CC",
                independent: "#A9A9A9",
                none: "#CCCCCC"
            },
            economic: {
                agricultural: "#90EE90",
                industrial: "#A0522D",
                commercial: "#4682B4",
                financial: "#FFD700",
                tech: "#9370DB",
                diversified: "#20B2AA",
                gold_rush: "#FFD700",
                none: "#CCCCCC"
            },
            policy: {
                new_deal_high: "#006400",
                civil_rights_high: "#8A2BE2",
                conservative_low: "#DC143C",
                none: "#D3D3D3"
            },
            demographics: {
                frontier: "#DEB887",
                immigrant_heavy: "#FF6347",
                urban: "#4169E1",
                suburban: "#32CD32",
                diverse_urban: "#FF1493",
                none: "#CCCCCC"
            },
            labor: {
                weak: "#FFB6C1",
                strong: "#228B22",
                very_strong: "#006400",
                declining: "#FFA500",
                mixed: "#9370DB",
                none: "#CCCCCC"
            }
        };

        let currentYear = 1776;
        let isPlaying = false;
        let animationFrame;
        let speed = 50;
        let usData;

        const svg = d3.select("#map-svg");
        const tooltip = d3.select("#tooltip");
        const yearDisplay = d3.select("#yearDisplay");
        const timeSlider = document.getElementById("timeSlider");
        const playBtn = document.getElementById("playBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const resetBtn = document.getElementById("resetBtn");
        const speedSelect = document.getElementById("speedSelect");
        const layerSelect = document.getElementById("layerSelect");
        const periodIndicator = d3.select("#periodIndicator");
        const legend = d3.select("#legend");
        const showLegendCheckbox = document.getElementById("showLegend");
        const showTooltipsCheckbox = document.getElementById("showTooltips");
        const animateTransitionsCheckbox = document.getElementById("animateTransitions");

        const width = svg.node().clientWidth;
        const height = svg.node().clientHeight;

        const projection = d3.geoAlbersUsa().fitSize([width, height], { type: "FeatureCollection", features: [] });
        const path = d3.geoPath().projection(projection);

        d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(data => {
            usData = data;
            const states = topojson.feature(usData, usData.objects.states);
            
            // Add the abbreviation property to each state object using the lookup table
            states.features.forEach(d => {
                d.properties.abbrev = stateAbbreviations[d.properties.name];
            });

            projection.fitSize([width, height], states);

            const statePaths = svg.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(states.features)
                .join("path")
                .attr("class", "state")
                .attr("d", path)
                .attr("id", d => `state-${d.properties.abbrev}`);
            
            const stateLabels = svg.append("g")
                .attr("class", "state-labels")
                .selectAll("text")
                .data(states.features)
                .join("text")
                .attr("x", d => path.centroid(d)[0])
                .attr("y", d => path.centroid(d)[1])
                .attr("class", "state-label")
                .text(d => d.properties.abbrev);

            statePaths
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
                .on("click", handleClick);

            updateMap();
        });

        function getDataForYear(stateId, layer, year) {
            const data = stateData[stateId] ? stateData[stateId][layer] : null;
            if (!data) return "none";

            const years = Object.keys(data).map(Number).sort((a, b) => a - b);
            let nearestYear = years[0];
            for (let i = 0; i < years.length; i++) {
                if (years[i] <= year) {
                    nearestYear = years[i];
                } else {
                    break;
                }
            }
            return data[nearestYear];
        }

        function updateMap() {
            const layer = layerSelect.value;
            const animate = animateTransitionsCheckbox.checked;

            yearDisplay.text(currentYear);
            const currentPeriod = historicalPeriods.find(p => currentYear >= p.years[0] && currentYear <= p.years[1]);
            if (currentPeriod) {
                periodIndicator.text(`${currentPeriod.name} (${currentPeriod.years[0]}-${currentPeriod.years[1]}): ${currentPeriod.description}`);
            }

            d3.selectAll(".state")
                .transition().duration(animate ? 500 : 0)
                .attr("fill", d => {
                    const stateAbbrev = d.properties.abbrev;
                    const value = getDataForYear(stateAbbrev, layer, currentYear);
                    return colors[layer][value] || "#CCCCCC";
                });

            updateLegend(layer);
        }

        function updateLegend(layer) {
            const legendData = colors[layer];
            legend.html('');
            legend.append("h4").text("Legend");
            
            const legendItems = legend.selectAll(".legend-item")
                .data(Object.keys(legendData))
                .join("div")
                .attr("class", "legend-item");
            
            legendItems.append("div")
                .attr("class", "legend-color")
                .style("background-color", d => legendData[d]);
            
            legendItems.append("span")
                .text(d => d.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()));
            
            legend.style("display", showLegendCheckbox.checked ? "block" : "none");
        }

        function handleMouseOver(event, d) {
            if (!showTooltipsCheckbox.checked) return;
            const layer = layerSelect.value;
            const value = getDataForYear(d.properties.abbrev, layer, currentYear);
            tooltip.style("opacity", 1)
                .html(`
                    <strong>${d.properties.name} (${d.properties.abbrev})</strong><br/>
                    Year: ${currentYear}<br/>
                    Data Layer: ${layer.replace(/\b\w/g, c => c.toUpperCase())}<br/>
                    Value: ${value.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}`
                )
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");
        }

        function handleMouseOut() {
            if (!showTooltipsCheckbox.checked) return;
            tooltip.style("opacity", 0);
        }

        function handleClick(event, d) {
            const layer = layerSelect.value;
            const stateAbbrev = d.properties.abbrev;
            const stateName = d.properties.name;

            let infoContent = `<h3>${stateName} (${stateAbbrev}) - ${currentYear}</h3>`;
            infoContent += `<p><strong>Data Layer:</strong> ${layer.replace(/\b\w/g, c => c.toUpperCase())}</p>`;
            
            if (stateData[stateAbbrev]) {
                const stateHist = stateData[stateAbbrev][layer] || {};
                infoContent += "<h4>Historical Timeline:</h4><ul>";
                Object.keys(stateHist).sort((a,b) => a - b).forEach(year => {
                    infoContent += `<li><strong>${year}:</strong> ${stateHist[year].replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</li>`;
                });
                infoContent += "</ul>";
            } else {
                infoContent += "<p>No detailed historical data available for this state.</p>";
            }

            d3.select("#infoPanel").html(infoContent);
        }

        // Controls
        timeSlider.addEventListener("input", (e) => {
            currentYear = +e.target.value;
            updateMap();
        });

        playBtn.addEventListener("click", () => {
            if (isPlaying) return;
            isPlaying = true;
            playBtn.disabled = true;
            pauseBtn.disabled = false;
            animateMap();
        });

        pauseBtn.addEventListener("click", () => {
            isPlaying = false;
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            cancelAnimationFrame(animationFrame);
        });

        resetBtn.addEventListener("click", () => {
            isPlaying = false;
            currentYear = 1776;
            timeSlider.value = currentYear;
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            cancelAnimationFrame(animationFrame);
            updateMap();
        });

        speedSelect.addEventListener("change", (e) => {
            speed = +e.target.value;
        });

        layerSelect.addEventListener("change", updateMap);

        showLegendCheckbox.addEventListener("change", () => {
            legend.style("display", showLegendCheckbox.checked ? "block" : "none");
        });
        showTooltipsCheckbox.addEventListener("change", () => {
            tooltip.style("opacity", 0);
        });
        animateTransitionsCheckbox.addEventListener("change", () => {
            // No action needed here, updateMap will handle it
        });

        function animateMap() {
            if (!isPlaying) return;
            
            let lastTimestamp = null;
            const step = (timestamp) => {
                if (!lastTimestamp) lastTimestamp = timestamp;
                const elapsed = timestamp - lastTimestamp;
                
                if (elapsed > speed) {
                    currentYear = (currentYear < 2025) ? currentYear + 1 : 1776;
                    timeSlider.value = currentYear;
                    updateMap();
                    lastTimestamp = timestamp;
                }
                animationFrame = requestAnimationFrame(step);
            };
            animationFrame = requestAnimationFrame(step);
        }

        // Initial call to set up the legend
        updateLegend(layerSelect.value);
    </script>
</body>
</html>







